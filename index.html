<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="ç¾©å¤§ç™Œé†«ç–«è‹—å†°ç®±æº«åº¦ç›£æ§æ™ºèƒ½ç³»çµ± - é©ç”¨æ–¼ GitHub Pages éƒ¨ç½²">
    <title>ç¾©å¤§ç™Œé†«ç–«è‹—å†°ç®±æº«åº¦ç›£æ§æ™ºèƒ½ç³»çµ±</title>
    
    <!-- 1. å¼•å…¥å¿…è¦çš„å‡½å¼åº« (CDN) -->
    <!-- Tailwind CSS: å¿«é€Ÿæ¨£å¼è¨­è¨ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js: ç¹ªè£½æº«åº¦è¶¨å‹¢åœ– -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Annotation Plugin: ç”¨æ–¼ç¹ªè£½è­¦ç¤ºç´…ç·š/è—ç·š -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- Tesseract.js: ç”¨æ–¼ OCR å½±åƒè¾¨è­˜ -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <!-- FontAwesome: åœ–ç¤ºåº« -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- æ ¸å¿ƒæ¨£å¼å€ --- */
        body { -webkit-tap-highlight-color: transparent; }
        input[type="month"], select, button { cursor: pointer; }
        
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: center;
        }
        input:focus {
            outline: 2px solid #3b82f6;
            border-color: transparent;
        }

        /* Modal (å½ˆå‡ºè¦–çª—) é€šç”¨æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* OCR Loading é®ç½© */
        .loading-overlay {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        /* ç°½åç•«å¸ƒ */
        canvas.signature-pad {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            cursor: crosshair;
            touch-action: none; /* é—œéµï¼šé˜²æ­¢æ‰‹æ©Ÿæ“ä½œæ™‚æ»‘å‹•é é¢ */
            background-color: #f8fafc;
            width: 100%;
            height: 200px;
        }

        /* ç°½åç¸®åœ– (é è¦½ç”¨) */
        .sig-preview {
            height: 40px;
            width: auto;
            border-bottom: 1px solid #e2e8f0;
            display: inline-block;
        }

        /* æ•´å±¤æƒææŒ‰éˆ•æ¨£å¼ */
        .layer-ocr-btn {
            background-color: #e0f2fe; /* blue-100 */
            color: #0284c7; /* sky-600 */
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            border: 1px solid #bae6fd;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 6px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .layer-ocr-btn:hover {
            background-color: #0284c7;
            color: white;
            border-color: #0284c7;
        }

        /* --- åˆ—å°å°ˆç”¨æ¨£å¼ (@media print) --- */
        @media print {
            @page {
                /* é›–ç„¶ JS æœƒå‹•æ…‹è¨­å®šï¼Œé€™è£¡ä¿ç•™é è¨­å€¼ */
                margin: 5mm; 
            }

            /* é—œéµï¼šå¼·åˆ¶ html å’Œ body å¡«æ»¿ä¸”ä¸æº¢å‡º */
            html, body {
                height: 100%;
                width: 100%;
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden !important; 
            }

            body {
                background-color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                font-size: 10pt;
            }

            /* éš±è—ç¶²é ä»‹é¢å…ƒç´  */
            .no-print, .modal, .loading-overlay, .layer-ocr-btn { display: none !important; }
            .print-only { display: block !important; }
            
            /* ç§»é™¤é™°å½±èˆ‡è£é£¾ï¼Œç¯€çœå¢¨æ°´ */
            .shadow, .shadow-md, .border-l-4, .rounded-lg {
                box-shadow: none !important;
                border: none !important;
                border-radius: 0 !important;
            }

            /* --- æ¨¡å¼ A: æœˆå ±è¡¨ (è¡¨æ ¼) --- */
            body.print-mode-table .chart-section { display: none !important; }
            body.print-mode-table .table-section { display: block !important; width: 100%; }
            body.print-mode-table table th, body.print-mode-table table td {
                border: 1px solid #000 !important;
                padding: 2px 4px !important;
            }
            
            /* ç°½ååœ–æª”åœ¨åˆ—å°æ™‚çš„å¤§å°æ§åˆ¶ */
            .sig-img-print {
                max-height: 25px; 
                max-width: 60px;
                object-fit: contain;
            }

            /* --- æ¨¡å¼ B: è¶¨å‹¢åœ– (å¼·åˆ¶å–®é æ¥µè‡´ä¿®æ­£) --- */
            body.print-mode-chart .table-section { display: none !important; }
            
            /* åœ–è¡¨å€å¡Šæ»¿ç‰ˆè¨­å®š */
            body.print-mode-chart .chart-section { 
                display: flex !important; 
                flex-direction: column;
                justify-content: space-between; /* ä¸Šä¸‹åˆ†ä½ˆ (æ¨™é¡Œ-åœ–-ç°½å) */
                align-items: center;
                height: 100% !important; /* çµ•å°å¡«æ»¿é é¢é«˜åº¦ */
                width: 100% !important; 
                page-break-inside: avoid;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
            }

            /* åœ–è¡¨æ¨™é¡Œ */
            body.print-mode-chart #chartTitle {
                font-size: 16pt !important;
                margin-top: 0 !important;
                margin-bottom: 5px !important;
                text-align: center;
                width: 100%;
                flex-shrink: 0; 
            }

            /* åœ–è¡¨å®¹å™¨ï¼šè‡ªå‹•ç¸®æ”¾å¡«æ»¿å‰©é¤˜ç©ºé–“ */
            body.print-mode-chart #chartContainer { 
                flex: 1 1 auto !important; /* åƒæ‰æ‰€æœ‰å‰©é¤˜é«˜åº¦ */
                width: 98% !important; /* å·¦å³ç•™ä¸€é»ç™½é‚Š */
                height: auto !important; 
                min-height: 0 !important; /* é—œéµï¼šå…è¨± Flex å­å…ƒç´ ç¸®å°ï¼Œé˜²æ­¢æ’é–‹ */
                margin: 0 auto !important;
                position: relative !important;
            }
            
            /* Canvas å¡«æ»¿å®¹å™¨ */
            body.print-mode-chart #tempChart {
                width: 100% !important;
                height: 100% !important;
            }

            /* ç°½åå€ï¼šå›ºå®šåœ¨åº•éƒ¨ */
            body.print-mode-chart .chart-footer-signatures {
                display: flex !important;
                width: 100%;
                justify-content: space-around;
                margin-top: 5px !important;
                margin-bottom: 0 !important;
                padding-bottom: 0 !important;
                font-size: 12pt;
                font-weight: bold;
                flex-shrink: 0;
            }
        }
        
        .print-only { display: none; }
        .chart-footer-signatures { display: none; }
    </style>
    <!-- ç”¨æ–¼å‹•æ…‹æ’å…¥ @page è¦å‰‡ (æ§åˆ¶ç›´å°/æ©«å°) -->
    <style id="page-style"></style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <!-- é ‚éƒ¨å°èˆªåˆ— -->
    <div class="bg-teal-700 text-white p-4 shadow-md no-print sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center flex-wrap gap-3">
            <h1 class="font-bold flex flex-col">
                <span class="text-xl flex items-center">
                    <i class="fa-solid fa-temperature-half mr-2"></i>
                    ç¾©å¤§ç™Œé†«ç–«è‹—å†°ç®±æº«åº¦ç›£æ§æ™ºèƒ½ç³»çµ±
                </span>
                <span class="text-xs font-normal opacity-80 md:ml-6 mt-1">E-Da Cancer Hospital Vaccine Cold Chain Smart Monitor System</span>
            </h1>
            
            <div class="flex gap-2 text-sm flex-wrap mt-2 md:mt-0">
                <!-- æª”æ¡ˆå‚™ä»½å€ -->
                <div class="bg-teal-800 p-1 rounded flex gap-1 border border-teal-600">
                    <button onclick="exportData()" class="bg-teal-600 hover:bg-teal-500 px-3 py-1.5 rounded transition" title="ä¸‹è¼‰å‚™ä»½ JSON">
                        <i class="fa-solid fa-download"></i> åŒ¯å‡º
                    </button>
                    <button onclick="document.getElementById('importFile').click()" class="bg-teal-600 hover:bg-teal-500 px-3 py-1.5 rounded transition" title="é‚„åŸå‚™ä»½ JSON">
                        <i class="fa-solid fa-upload"></i> åŒ¯å…¥
                    </button>
                    <input type="file" id="importFile" accept=".json" class="hidden" onchange="importData(this)">
                </div>

                <!-- æ“ä½œå€ -->
                <button onclick="saveData(true)" class="bg-blue-600 hover:bg-blue-500 px-4 py-1.5 rounded transition shadow border border-blue-400 font-bold">
                    <i class="fa-solid fa-floppy-disk"></i> æš«å­˜
                </button>
                <button onclick="showPrintModal()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-1.5 rounded transition shadow border border-indigo-400 font-bold">
                    <i class="fa-solid fa-print"></i> åˆ—å°
                </button>
                <button onclick="clearData()" class="bg-red-600 hover:bg-red-500 px-4 py-1.5 rounded transition shadow border border-red-400 font-bold">
                    <i class="fa-solid fa-trash-can"></i> æ¸…é™¤
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 max-w-7xl">
        
        <!-- OCR éš±è— Input (ç”¨æ–¼è§¸ç™¼æ‰‹æ©Ÿç›¸æ©Ÿ) -->
        <input type="file" id="ocrInput" accept="image/*" capture="environment" class="hidden" onchange="processOCR(this)">
        
        <!-- 1. é¸æ“‡å€ (æ—¥æœŸèˆ‡æç¤º) -->
        <div class="bg-white p-6 rounded-lg shadow mb-6 no-print border-l-4 border-teal-500">
            <div class="flex flex-wrap items-end gap-6">
                <div>
                    <label class="block text-sm font-bold mb-1 text-gray-600"><i class="fa-regular fa-calendar mr-1"></i>1. é¸æ“‡æœˆä»½</label>
                    <input type="month" id="monthPicker" class="border p-2 rounded w-48 shadow-sm cursor-pointer hover:bg-gray-50 transition font-bold text-lg text-teal-700" 
                           onclick="openDatepicker(this)" onchange="changeMonth()">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1 text-gray-600"><i class="fa-regular fa-clock mr-1"></i>2. é¸æ“‡æ—¥æœŸ</label>
                    <select id="dayPicker" class="border p-2 rounded w-32 shadow-sm cursor-pointer hover:bg-gray-50 transition font-bold text-lg" onchange="loadDayData()">
                        <!-- JS å‹•æ…‹ç”Ÿæˆæ—¥æœŸé¸é … -->
                    </select>
                </div>
                <div class="text-sm text-gray-500 bg-gray-50 p-2 rounded border border-gray-200">
                    <i class="fa-solid fa-camera mr-1"></i> æç¤ºï¼šé»æ“Šã€Œç¬¬Xå±¤ã€æ—çš„ <span class="text-sky-600 font-bold">æƒæ</span> æŒ‰éˆ•ï¼Œå³å¯ä¸€æ¬¡è¾¨è­˜ <span class="font-bold">Maxã€Minã€ç•¶ä¸‹</span> ä¸‰å€‹æº«åº¦ã€‚
                </div>
            </div>
        </div>

        <!-- 2. è¼¸å…¥å€å¡Š (ä¸Šåˆ AM / ä¸‹åˆ PM) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 no-print">
            <!-- AM å€å¡Š -->
            <div class="bg-white p-6 rounded-lg shadow border-l-4 border-blue-500">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-blue-700">â˜€ï¸ ä¸Šåˆ (AM)</h3>
                    <!-- ç°½åæŒ‰éˆ•å€ -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-bold">ç°½å:</label>
                        <div id="am-sig-container" class="h-10 w-24 border border-gray-300 bg-gray-50 rounded flex items-center justify-center overflow-hidden relative bg-white cursor-pointer" onclick="openSignaturePad('am')">
                            <span class="text-xs text-gray-400 select-none">é»æ“Šç°½å</span>
                            <img id="am-sig-img" class="absolute top-0 left-0 w-full h-full object-contain hidden" />
                        </div>
                    </div>
                </div>
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600">
                            <th class="p-2 text-left w-24">å±¤æ•¸ (ç›¸æ©Ÿ)</th>
                            <th class="p-2">æœ€é«˜ (Max)</th>
                            <th class="p-2">æœ€ä½ (Min)</th>
                            <th class="p-2">ç•¶ä¸‹ (Cur)</th>
                        </tr>
                    </thead>
                    <tbody id="am-tbody">
                        <!-- JS å‹•æ…‹ç”Ÿæˆ 5 å±¤è¼¸å…¥æ¡† -->
                    </tbody>
                    <tfoot class="bg-blue-50 font-bold border-t-2 border-blue-100">
                        <tr>
                            <td class="p-2">æœ€çµ‚åƒè€ƒ</td>
                            <td class="p-2 text-center text-red-600 text-lg" id="am-final-max">-</td>
                            <td class="p-2 text-center text-blue-600 text-lg" id="am-final-min">-</td>
                            <td class="p-2 text-center text-green-600 text-lg" id="am-final-avg">-</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- PM å€å¡Š -->
            <div class="bg-white p-6 rounded-lg shadow border-l-4 border-orange-500">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-orange-700">ğŸŒ™ ä¸‹åˆ (PM)</h3>
                    <!-- ç°½åæŒ‰éˆ•å€ -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-bold">ç°½å:</label>
                        <div id="pm-sig-container" class="h-10 w-24 border border-gray-300 bg-gray-50 rounded flex items-center justify-center overflow-hidden relative bg-white cursor-pointer" onclick="openSignaturePad('pm')">
                            <span class="text-xs text-gray-400 select-none">é»æ“Šç°½å</span>
                            <img id="pm-sig-img" class="absolute top-0 left-0 w-full h-full object-contain hidden" />
                        </div>
                    </div>
                </div>
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600">
                            <th class="p-2 text-left w-24">å±¤æ•¸ (ç›¸æ©Ÿ)</th>
                            <th class="p-2">æœ€é«˜ (Max)</th>
                            <th class="p-2">æœ€ä½ (Min)</th>
                            <th class="p-2">ç•¶ä¸‹ (Cur)</th>
                        </tr>
                    </thead>
                    <tbody id="pm-tbody">
                        <!-- JS å‹•æ…‹ç”Ÿæˆ 5 å±¤è¼¸å…¥æ¡† -->
                    </tbody>
                    <tfoot class="bg-orange-50 font-bold border-t-2 border-orange-100">
                        <tr>
                            <td class="p-2">æœ€çµ‚åƒè€ƒ</td>
                            <td class="p-2 text-center text-red-600 text-lg" id="pm-final-max">-</td>
                            <td class="p-2 text-center text-blue-600 text-lg" id="pm-final-min">-</td>
                            <td class="p-2 text-center text-green-600 text-lg" id="pm-final-avg">-</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- åˆ—å°æ™‚é¡¯ç¤ºçš„æ¨™é¡Œ (å¹³å¸¸éš±è—) -->
        <div class="print-only text-center mb-2">
            <h2 class="text-2xl font-bold">ç¾©å¤§ç™Œé†«ç–«è‹—å†°ç®±æº«åº¦ç›£æ¸¬è¨˜éŒ„è¡¨</h2>
            <p class="text-lg mt-1 font-semibold">æœˆä»½: <span id="printMonthLabel"></span></p>
            <div class="flex justify-between text-xs text-gray-600 mt-2 px-4 border-b pb-2">
                <span>æ¨™æº–ç¯„åœï¼š2Â°C ~ 8Â°C</span>
                <span>è­¦ç¤ºç·šï¼šè—è‰² 2Â°C / ç´…è‰² 8Â°C / æ©˜è‰² -10Â°C</span>
            </div>
        </div>

        <!-- 3. æœˆå ±è¡¨ç¸½è¦½è¡¨æ ¼ (èª¿æ•´é †åºï¼šç§»è‡³åœ–è¡¨å‰) -->
        <div class="bg-white p-6 rounded-lg shadow page-break border border-gray-200 table-section mb-6">
            <h3 class="text-lg font-bold mb-4 no-print" id="summaryTitle">æœˆå ±è¡¨ç¸½è¦½</h3>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300 text-sm text-center">
                    <thead>
                        <tr class="bg-gray-200">
                            <th rowspan="2" class="border border-gray-400 p-1 w-10">æ—¥æœŸ</th>
                            <th colspan="3" class="border border-gray-400 p-1 bg-blue-100">ä¸Šåˆ (AM)</th>
                            <th colspan="3" class="border border-gray-400 p-1 bg-orange-100">ä¸‹åˆ (PM)</th>
                            <th colspan="2" class="border border-gray-400 p-1 bg-gray-100">äººå“¡ç°½ç« </th>
                            <th rowspan="2" class="border border-gray-400 p-1 w-20">å‚™è¨»</th>
                        </tr>
                        <tr class="bg-gray-100 font-semibold text-xs">
                            <th class="border border-gray-400 p-1 w-10">æœ€é«˜</th>
                            <th class="border border-gray-400 p-1 w-10">æœ€ä½</th>
                            <th class="border border-gray-400 p-1 w-10">ç•¶ä¸‹</th>
                            <th class="border border-gray-400 p-1 w-10">æœ€é«˜</th>
                            <th class="border border-gray-400 p-1 w-10">æœ€ä½</th>
                            <th class="border border-gray-400 p-1 w-10">ç•¶ä¸‹</th>
                            <th class="border border-gray-400 p-1 w-16">ä¸Šåˆ</th>
                            <th class="border border-gray-400 p-1 w-16">ä¸‹åˆ</th>
                        </tr>
                    </thead>
                    <tbody id="monthlySummaryBody">
                        <!-- JS å‹•æ…‹å¡«å…¥æœˆå ±è¡¨ -->
                    </tbody>
                </table>
            </div>
            <!-- åˆ—å°ç‰ˆå°¾ (æœˆå ±è¡¨ç”¨) -->
            <div class="print-only mt-6 flex justify-between px-10 text-sm font-bold">
                <div>ç®¡ç†è—¥å¸«ç°½ç« : _________________</div>
                <div>ä¸»ä»»ç°½ç« : _________________</div>
            </div>
        </div>

        <!-- 4. è¶¨å‹¢åœ–è¡¨å€ (èª¿æ•´é †åºï¼šç§»è‡³æœ€ä¸‹æ–¹) -->
        <div class="bg-white p-4 rounded-lg shadow mb-6 break-inside-avoid border border-gray-200 chart-section">
            <h3 class="text-lg font-bold mb-2 text-gray-700" id="chartTitle">
                <i class="fa-solid fa-chart-line mr-2"></i>å†°ç®±æº«åº¦è¨˜éŒ„è¡¨(æº«åº¦è¶¨å‹¢åœ–)
            </h3>
            <!-- å¢åŠ åœ–è¡¨é«˜åº¦ä»¥åˆ©è¦–è¦ºè¾¨è­˜ -->
            <div id="chartContainer" style="position: relative; height: 450px; width: 100%;">
                <canvas id="tempChart"></canvas>
            </div>
            <!-- åœ–è¡¨ä¸‹æ–¹ç°½åæ¬„ (åˆ—å°åœ–è¡¨æ¨¡å¼æ™‚é¡¯ç¤º) -->
            <div class="chart-footer-signatures mt-8 flex justify-between px-16 text-lg font-bold text-gray-800">
                <div class="px-4">ç®¡ç†è—¥å¸«ç°½ç« : _________________</div>
                <div class="px-4">ä¸»ç®¡ç°½ç« : _________________</div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay (OCR é€²è¡Œä¸­é¡¯ç¤º) -->
    <div id="loadingOverlay" class="loading-overlay">
        <i class="fa-solid fa-spinner fa-spin text-5xl mb-4 text-blue-400"></i>
        <div class="text-xl font-bold">AI å½±åƒè¾¨è­˜ä¸­...</div>
        <div class="text-sm mt-2 text-gray-300">æ­£åœ¨åˆ†æ Max / Min / Current æº«åº¦...</div>
        <canvas id="ocrCanvas" class="mt-4 border border-gray-500 hidden" width="300" height="100"></canvas>
    </div>

    <!-- åˆ—å°é¸é … Modal -->
    <div id="printModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-gray-800">è«‹é¸æ“‡åˆ—å°æ¨¡å¼</h2>
            <div class="flex flex-col gap-3">
                <button onclick="printReport('table', this)" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-4 rounded-lg flex items-center justify-center gap-3 shadow transition">
                    <i class="fa-solid fa-table text-xl w-8"></i>
                    <div class="text-left flex-1">
                        <div class="font-bold text-lg">æœˆå ±è¡¨ç¸½è¦½</div>
                        <div class="text-xs opacity-80">A4 ç›´å¼ - è¡¨æ ¼</div>
                    </div>
                </button>
                <button onclick="printReport('chart', this)" class="bg-teal-600 hover:bg-teal-500 text-white px-4 py-4 rounded-lg flex items-center justify-center gap-3 shadow transition">
                    <i class="fa-solid fa-chart-line text-xl w-8"></i>
                    <div class="text-left flex-1">
                        <div class="font-bold text-lg">æº«åº¦è¶¨å‹¢åœ–</div>
                        <div class="text-xs opacity-80">A4 æ©«å¼ - å–®é åœ–è¡¨</div>
                    </div>
                </button>
            </div>
            <button onclick="closePrintModal()" class="mt-6 text-gray-500 hover:text-gray-800 underline text-sm">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- ç°½åæ¿ Modal -->
    <div id="signatureModal" class="modal">
        <div class="modal-content">
            <h2 class="text-lg font-bold mb-2">è«‹åœ¨æ­¤ç°½å</h2>
            <p class="text-xs text-gray-500 mb-2">è«‹ä½¿ç”¨æ‰‹æŒ‡ã€è§¸æ§ç­†æˆ–æ»‘é¼ æ›¸å¯«</p>
            
            <canvas id="signatureCanvas" width="400" height="200" class="signature-pad"></canvas>
            
            <div class="flex justify-center gap-3 mt-4">
                <button onclick="clearSignature()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">æ¸…é™¤é‡å¯«</button>
                <button onclick="saveSignature()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold">ç¢ºèªç°½å</button>
            </div>
            <button onclick="closeSignatureModal()" class="mt-3 text-gray-500 underline text-sm">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // --- 1. å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ– ---
        let currentYear, currentMonth;
        let chartInstance = null;
        const storageKey = "vaccine_fridge_data_universal"; // LocalStorage å„²å­˜éµå€¼
        
        // OCR ç›¸é—œ
        let currentOcrContext = null; // å„²å­˜ç•¶å‰æ­£åœ¨æƒæçš„ { period: 'am', layer: 1 }

        // ç°½åæ¿ç›¸é—œ
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let currentSigTarget = ''; // 'am' or 'pm'
        let canvas, ctx;

        // ç¶²é è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            try {
                migrateOldData(); // èˆŠè³‡æ–™é·ç§»(é é˜²æªæ–½)
                initSignaturePad(); // åˆå§‹åŒ–ç°½åæ¿
                
                // è¨­å®šé è¨­æœˆä»½ç‚ºç•¶å‰æœˆä»½
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                
                const monthPicker = document.getElementById('monthPicker');
                if(monthPicker) { monthPicker.value = `${year}-${month}`; }
                
                initInputTables(); // å»ºç«‹è¼¸å…¥è¡¨æ ¼
                changeMonth();     // è¼‰å…¥è©²æœˆè³‡æ–™
            } catch (e) {
                console.error("Init Error:", e);
                alert("åˆå§‹åŒ–éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚");
            }
        });

        // è¼”åŠ©ï¼šé–‹å•Ÿæ—¥æœŸé¸æ“‡å™¨ (è™•ç†ç€è¦½å™¨ç›¸å®¹æ€§)
        function openDatepicker(el) { try { if(typeof el.showPicker === 'function') el.showPicker(); } catch(e){} }

        // --- 2. OCR å½±åƒè¾¨è­˜åŠŸèƒ½ (æ•´å±¤æƒæ) ---
        function triggerLayerOCR(period, layer) {
            currentOcrContext = { period, layer };
            // è§¸ç™¼éš±è—çš„ file inputï¼Œé–‹å•Ÿç›¸æ©Ÿæˆ–æª”æ¡ˆé¸æ“‡
            document.getElementById('ocrInput').click();
        }

        async function processOCR(fileInput) {
            if (!fileInput.files || !fileInput.files[0]) return;
            
            const file = fileInput.files[0];
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex'; // é¡¯ç¤º Loading é®ç½©

            try {
                // A. åœ–ç‰‡é è™•ç† (å¢å¼·å°æ¯”ï¼Œæé«˜ 7-segment è¾¨è­˜ç‡)
                const processedImage = await preprocessImage(file);
                
                // B. åŸ·è¡Œ Tesseract OCR
                const worker = await Tesseract.createWorker('eng'); // ä¸‹è¼‰è‹±æ–‡è¾¨è­˜æ¨¡å‹
                await worker.setParameters({
                    tessedit_char_whitelist: '0123456789.-', // ç™½åå–®ï¼šåªå…è¨±æ•¸å­—ã€é»ã€è² è™Ÿ
                });

                const ret = await worker.recognize(processedImage);
                await worker.terminate(); // é‡‹æ”¾è³‡æº

                console.log("OCR Raw Text:", ret.data.text);

                // C. æå–èˆ‡éæ¿¾æ•¸å­—
                // Regex æŠ“å–æ‰€æœ‰æµ®é»æ•¸æˆ–æ•´æ•¸ (ä¾‹å¦‚: 5.2, 12, -2.1)
                const numbers = ret.data.text.match(/-?\d+(\.\d+)?/g);

                if (!numbers || numbers.length === 0) {
                    throw new Error("æœªåµæ¸¬åˆ°ä»»ä½•æ•¸å­—");
                }

                // éæ¿¾ä¸åˆç†çš„æ•¸å€¼ (å‡è¨­ç–«è‹—å†°ç®±ç¯„åœ -50 ~ 50ï¼Œé¿å…è¾¨è­˜å‡ºå¹´ä»½æˆ–é›œè¨Š)
                let validNumbers = numbers
                    .map(Number)
                    .filter(n => !isNaN(n) && n > -50 && n < 50);

                // å»é™¤é‡è¤‡å€¼
                validNumbers = [...new Set(validNumbers)];
                console.log("Valid Numbers:", validNumbers);

                // D. è‡ªå‹•å¡«å…¥é‚è¼¯ (åŸºæ–¼æ•¸å€¼æ’åº)
                if (validNumbers.length > 0) {
                    validNumbers.sort((a, b) => a - b); // å° -> å¤§
                    
                    let maxVal, minVal, curVal;

                    if (validNumbers.length >= 3) {
                        // æŠ“åˆ°3å€‹ä»¥ä¸Šï¼šæœ€å°=Min, æœ€å¤§=Max, ä¸­é–“(æˆ–ç¬¬äºŒå€‹)=Cur
                        minVal = validNumbers[0]; 
                        maxVal = validNumbers[validNumbers.length - 1]; 
                        curVal = validNumbers[1]; 
                    } else if (validNumbers.length === 2) {
                        // åªæŠ“åˆ°2å€‹ï¼šå‡è¨­æ˜¯ Min å’Œ Max
                        minVal = validNumbers[0];
                        maxVal = validNumbers[1];
                        curVal = null; // ç•¶ä¸‹å€¼ä¸æ˜
                        alert(`åµæ¸¬åˆ° 2 å€‹æ•¸å€¼ (${minVal}, ${maxVal})ã€‚å·²å¡«å…¥ Min/Maxï¼Œè«‹æ‰‹å‹•ç¢ºèªã€Œç•¶ä¸‹ã€æº«åº¦ã€‚`);
                    } else if (validNumbers.length === 1) {
                        curVal = validNumbers[0];
                        alert(`åªåµæ¸¬åˆ° 1 å€‹æ•¸å€¼ (${curVal})ã€‚å·²å¡«å…¥ã€Œç•¶ä¸‹ã€æ¬„ä½ã€‚`);
                    }

                    // å¡«å…¥å°æ‡‰çš„ Input
                    if (currentOcrContext) {
                        const { period, layer } = currentOcrContext;
                        const row = document.querySelector(`.${period}-max[data-layer="${layer}"]`).closest('tr');
                        
                        if (maxVal !== undefined && maxVal !== null) {
                            const input = row.querySelector(`.${period}-max`);
                            input.value = maxVal;
                            highlightInput(input);
                        }
                        if (minVal !== undefined && minVal !== null) {
                            const input = row.querySelector(`.${period}-min`);
                            input.value = minVal;
                            highlightInput(input);
                        }
                        if (curVal !== undefined && curVal !== null) {
                            const input = row.querySelector(`.${period}-cur`);
                            input.value = curVal;
                            highlightInput(input);
                        }
                        
                        // è§¸ç™¼ç¸½çµè¨ˆç®—
                        calculateDailySummary(period);
                    }
                } else {
                    alert("æœªèƒ½è¾¨è­˜å‡ºæœ‰æ•ˆæº«åº¦æ•¸å€¼ï¼Œè«‹èª¿æ•´è§’åº¦é‡è©¦ã€‚");
                }

            } catch (error) {
                console.error("OCR Error:", error);
                alert("è¾¨è­˜ç™¼ç”ŸéŒ¯èª¤æˆ–æœªæ‰¾åˆ°æ•¸å­—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚");
            } finally {
                loadingOverlay.style.display = 'none'; // éš±è— Loading
                fileInput.value = ''; // é‡ç½® input ç‹€æ…‹
                currentOcrContext = null;
            }
        }

        // UX: å¡«å…¥å¾Œé–ƒçˆç¶ è‰²èƒŒæ™¯æç¤º
        function highlightInput(input) {
            input.style.backgroundColor = '#d1fae5'; // light green
            setTimeout(() => {
                input.style.backgroundColor = '';
            }, 1500);
        }

        // å½±åƒé è™•ç†æ¼”ç®—æ³•
        function preprocessImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const maxDimension = 1000;
                    let width = img.width;
                    let height = img.height;
                    
                    // ç­‰æ¯”ä¾‹ç¸®æ”¾ï¼Œé¿å…éå¤§åœ–ç‰‡å°è‡´è™•ç†éæ…¢
                    if (width > height) {
                        if (width > maxDimension) {
                            height *= maxDimension / width;
                            width = maxDimension;
                        }
                    } else {
                        if (height > maxDimension) {
                            width *= maxDimension / height;
                            height = maxDimension;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const data = imageData.data;
                    
                    // ç°éšèˆ‡å°æ¯”åº¦å¢å¼·
                    const contrast = 50; // 0~100 å¼·åº¦
                    const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));

                    for (let i = 0; i < data.length; i += 4) {
                        // è½‰ç°éš (Average method)
                        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        
                        // æ‡‰ç”¨å°æ¯”åº¦å…¬å¼
                        let newColor = factor * (avg - 128) + 128;
                        newColor = Math.max(0, Math.min(255, newColor));

                        data[i] = newColor;     // R
                        data[i + 1] = newColor; // G
                        data[i + 2] = newColor; // B
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    resolve(canvas.toDataURL('image/jpeg'));
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // --- 3. ç°½åæ¿åŠŸèƒ½ (Canvas) ---
        function initSignaturePad() {
            canvas = document.getElementById('signatureCanvas');
            ctx = canvas.getContext('2d');
            
            // æ»‘é¼ äº‹ä»¶
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // è§¸æ§äº‹ä»¶ (æ”¯æ´å¹³æ¿/æ‰‹æ©Ÿ)
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); 
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                lastX = touch.clientX - rect.left;
                lastY = touch.clientY - rect.top;
                isDrawing = true;
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!isDrawing) return;
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                drawLine(lastX, lastY, x, y);
                lastX = x;
                lastY = y;
            });
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function draw(e) {
            if (!isDrawing) return;
            drawLine(lastX, lastY, e.offsetX, e.offsetY);
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function drawLine(x1, y1, x2, y2) {
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.stroke();
        }

        function stopDrawing() { isDrawing = false; }

        function openSignaturePad(target) {
            currentSigTarget = target;
            document.getElementById('signatureModal').style.display = 'flex';
            clearSignature();
            resizeCanvas(); // ç¢ºä¿ Canvas è§£æåº¦æ­£ç¢º
        }

        // è™•ç†è¦–ç¶²è†œè¢å¹•è§£æåº¦ (Retina Display)
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            ctx.scale(ratio, ratio);
        }

        function closeSignatureModal() {
            document.getElementById('signatureModal').style.display = 'none';
        }

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function saveSignature() {
            // å„ªåŒ–ï¼šå»ºç«‹å°å‹ Canvas å£“ç¸®åœ–ç‰‡ï¼Œé¿å…å­˜å…¥éå¤§ Base64 å­—ä¸²
            const targetWidth = 300; 
            const scale = targetWidth / canvas.width;
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = targetWidth;
            tempCanvas.height = canvas.height * scale;
            
            const tCtx = tempCanvas.getContext('2d');
            tCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
            
            const dataUrl = tempCanvas.toDataURL('image/png');
            
            // æ›´æ–° UI
            const imgEl = document.getElementById(`${currentSigTarget}-sig-img`);
            const container = document.getElementById(`${currentSigTarget}-sig-container`);
            
            imgEl.src = dataUrl;
            imgEl.classList.remove('hidden');
            container.querySelector('span').classList.add('hidden');
            
            // è‡ªå‹•å­˜æª”
            saveData(false);
            closeSignatureModal();
        }

        // --- 4. åˆ—å°æ§åˆ¶ ---
        function showPrintModal() { document.getElementById('printModal').style.display = "flex"; }
        function closePrintModal() { document.getElementById('printModal').style.display = "none"; }

        function printReport(type, btnElement) {
            const originalText = btnElement.innerHTML;
            btnElement.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> è™•ç†ä¸­...';
            
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    try {
                        closePrintModal();
                        btnElement.innerHTML = originalText;
                        const body = document.body;
                        const style = document.getElementById('page-style');
                        
                        body.classList.remove('print-mode-table', 'print-mode-chart');

                        if (type === 'table') {
                            body.classList.add('print-mode-table');
                            style.innerHTML = '@page { size: portrait; margin: 10mm; }'; // ç›´å°
                            window.print();
                        } 
                        else if (type === 'chart') {
                            body.classList.add('print-mode-chart');
                            style.innerHTML = '@page { size: landscape; margin: 5mm; }'; // æ©«å°
                            
                            if (chartInstance) chartInstance.resize();
                            
                            requestAnimationFrame(() => {
                                window.print();
                            });
                        }
                    } catch (e) {
                        alert("åˆ—å°å•Ÿå‹•å¤±æ•—");
                        btnElement.innerHTML = originalText;
                    }
                });
            });
        }

        // --- 5. è³‡æ–™å­˜å–èˆ‡è¨ˆç®—é‚è¼¯ ---
        function migrateOldData() {
            if (!localStorage.getItem(storageKey)) {
                const v3 = localStorage.getItem("vaccine_fridge_data_v3");
                if (v3) localStorage.setItem(storageKey, v3);
            }
        }

        function initInputTables() {
            const layers = 5;
            const amBody = document.getElementById('am-tbody');
            const pmBody = document.getElementById('pm-tbody');
            let amHtml = '', pmHtml = '';
            
            for (let i = 1; i <= layers; i++) {
                // æ¯å±¤çš„ OCR æŒ‰éˆ• HTML
                const ocrBtn = (period) => `
                    <button class="layer-ocr-btn no-print" onclick="triggerLayerOCR('${period}', ${i})">
                        <i class="fa-solid fa-camera"></i> æƒæ
                    </button>
                `;

                amHtml += `
                    <tr>
                        <td class="p-2 font-semibold text-gray-700 whitespace-nowrap">
                            ç¬¬ ${i} å±¤ ${ocrBtn('am')}
                        </td>
                        <td class="p-1"><input type="number" step="0.1" class="am-max bg-gray-50 focus:bg-white" data-layer="${i}" onchange="calculateDailySummary('am')"></td>
                        <td class="p-1"><input type="number" step="0.1" class="am-min bg-gray-50 focus:bg-white" data-layer="${i}" onchange="calculateDailySummary('am')"></td>
                        <td class="p-1"><input type="number" step="0.1" class="am-cur bg-gray-50 focus:bg-white" data-layer="${i}" onchange="calculateDailySummary('am')"></td>
                    </tr>`;
                pmHtml += `
                    <tr>
                        <td class="p-2 font-semibold text-gray-700 whitespace-nowrap">
                            ç¬¬ ${i} å±¤ ${ocrBtn('pm')}
                        </td>
                        <td class="p-1"><input type="number" step="0.1" class="pm-max bg-gray-50 focus:bg-white" data-layer="${i}" onchange="calculateDailySummary('pm')"></td>
                        <td class="p-1"><input type="number" step="0.1" class="pm-min bg-gray-50 focus:bg-white" data-layer="${i}" onchange="calculateDailySummary('pm')"></td>
                        <td class="p-1"><input type="number" step="0.1" class="pm-cur bg-gray-50 focus:bg-white" data-layer="${i}" onchange="calculateDailySummary('pm')"></td>
                    </tr>`;
            }
            amBody.innerHTML = amHtml;
            pmBody.innerHTML = pmHtml;
        }

        function changeMonth() {
            const picker = document.getElementById('monthPicker').value;
            if (!picker) return;
            [currentYear, currentMonth] = picker.split('-').map(Number);
            
            // æ›´æ–°åˆ—å°ç‰ˆé¢èˆ‡ç¶²é ç‰ˆé¢çš„æ¨™é¡Œæ–‡å­—
            const formattedDate = `${currentYear} å¹´ ${currentMonth} æœˆ`;
            document.getElementById('printMonthLabel').textContent = formattedDate;
            document.getElementById('summaryTitle').textContent = `${formattedDate} ç™Œé†«ç–«è‹—å†°ç®±æº«åº¦ç›£æ§æœˆå ±è¡¨`;
            document.getElementById('chartTitle').innerHTML = `<i class="fa-solid fa-chart-line mr-2"></i>${formattedDate} å†°ç®±æº«åº¦è¨˜éŒ„è¡¨(æº«åº¦è¶¨å‹¢åœ–)`;

            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const dayPicker = document.getElementById('dayPicker');
            dayPicker.innerHTML = '';
            
            // é è¨­é¸ä¸­ç•¶å¤©
            const today = new Date();
            let defaultDay = 1;
            if(today.getFullYear() === currentYear && (today.getMonth()+1) === currentMonth) {
                defaultDay = today.getDate();
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.text = `${i} æ—¥`;
                if(i === defaultDay) option.selected = true;
                dayPicker.appendChild(option);
            }
            loadDayData(); 
            updateMonthlyReport(); 
            updateChart(); 
        }

        function loadDayData() {
            const day = document.getElementById('dayPicker').value;
            const monthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            const fullData = JSON.parse(localStorage.getItem(storageKey)) || {};
            
            // æ¸…ç©ºæ‰€æœ‰è¼¸å…¥æ¡†
            document.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
            
            // é‡ç½®ç°½å UI
            const resetSig = (target) => {
                document.getElementById(`${target}-sig-img`).src = "";
                document.getElementById(`${target}-sig-img`).classList.add('hidden');
                document.getElementById(`${target}-sig-container`).querySelector('span').classList.remove('hidden');
            };
            resetSig('am');
            resetSig('pm');

            if (fullData[monthKey] && fullData[monthKey][day]) {
                const data = fullData[monthKey][day];
                
                // è¼‰å…¥ AM
                if (data.am && data.am.layers) {
                    data.am.layers.forEach(layer => {
                        const row = document.querySelector(`.am-max[data-layer="${layer.id}"]`)?.closest('tr');
                        if(row) {
                            row.querySelector('.am-max').value = layer.max;
                            row.querySelector('.am-min').value = layer.min;
                            row.querySelector('.am-cur').value = layer.cur;
                        }
                    });
                    if(data.am.sigImage) {
                        const img = document.getElementById('am-sig-img');
                        img.src = data.am.sigImage;
                        img.classList.remove('hidden');
                        document.getElementById('am-sig-container').querySelector('span').classList.add('hidden');
                    }
                }
                
                // è¼‰å…¥ PM
                if (data.pm && data.pm.layers) {
                    data.pm.layers.forEach(layer => {
                        const row = document.querySelector(`.pm-max[data-layer="${layer.id}"]`)?.closest('tr');
                        if(row) {
                            row.querySelector('.pm-max').value = layer.max;
                            row.querySelector('.pm-min').value = layer.min;
                            row.querySelector('.pm-cur').value = layer.cur;
                        }
                    });
                     if(data.pm.sigImage) {
                        const img = document.getElementById('pm-sig-img');
                        img.src = data.pm.sigImage;
                        img.classList.remove('hidden');
                        document.getElementById('pm-sig-container').querySelector('span').classList.add('hidden');
                    }
                }
            }
            // é‡æ–°è¨ˆç®—æ¯æ—¥ç¸½çµ (ä¸è‡ªå‹•å­˜æª”)
            calculateDailySummary('am', false);
            calculateDailySummary('pm', false);
        }

        function calculateDailySummary(period, autoSave = true) {
            const maxInputs = Array.from(document.querySelectorAll(`.${period}-max`));
            const minInputs = Array.from(document.querySelectorAll(`.${period}-min`));
            const curInputs = Array.from(document.querySelectorAll(`.${period}-cur`));
            
            const maxVals = maxInputs.map(i => parseFloat(i.value)).filter(v => !isNaN(v));
            const minVals = minInputs.map(i => parseFloat(i.value)).filter(v => !isNaN(v));
            const curVals = curInputs.map(i => parseFloat(i.value)).filter(v => !isNaN(v));

            let finalMax = maxVals.length ? Math.max(...maxVals) : '-';
            let finalMin = minVals.length ? Math.min(...minVals) : '-';
            // ç•¶ä¸‹æº«åº¦å–äº”å±¤ä¸­æœ€ä½æº«
            let finalAvg = curVals.length ? Math.min(...curVals) : '-';

            document.getElementById(`${period}-final-max`).textContent = finalMax;
            document.getElementById(`${period}-final-min`).textContent = finalMin;
            document.getElementById(`${period}-final-avg`).textContent = finalAvg;

            if (autoSave) saveData(false);
        }

        function saveData(showFeedback = false) {
            try {
                const day = document.getElementById('dayPicker').value;
                const monthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
                
                const fullData = JSON.parse(localStorage.getItem(storageKey)) || {};
                if (!fullData[monthKey]) fullData[monthKey] = {};
                
                const amSigImg = document.getElementById('am-sig-img');
                const pmSigImg = document.getElementById('pm-sig-img');
                const amSigData = (!amSigImg.classList.contains('hidden')) ? amSigImg.src : null;
                const pmSigData = (!pmSigImg.classList.contains('hidden')) ? pmSigImg.src : null;

                const dailyData = {
                    am: { ...getLayerData('am'), sigImage: amSigData },
                    pm: { ...getLayerData('pm'), sigImage: pmSigData },
                    summary: { am: getSummaryData('am'), pm: getSummaryData('pm') }
                };

                fullData[monthKey][day] = dailyData;
                localStorage.setItem(storageKey, JSON.stringify(fullData));
                
                updateMonthlyReport();
                updateChart();

                if (showFeedback) alert(`âœ… å„²å­˜æˆåŠŸï¼\næ—¥æœŸï¼š${currentYear}/${currentMonth}/${day}`);
            } catch (error) {
                console.error(error);
                alert("âŒ å„²å­˜å¤±æ•— (ç©ºé–“ä¸è¶³)ã€‚è«‹åŸ·è¡Œã€ŒåŒ¯å‡ºã€å‚™ä»½å¾Œã€Œæ¸…é™¤ã€èˆŠè³‡æ–™ã€‚");
            }
        }

        function getLayerData(period) {
            const layers = [];
            for(let i=1; i<=5; i++) {
                const row = document.querySelector(`.${period}-max[data-layer="${i}"]`).closest('tr');
                layers.push({
                    id: i,
                    max: row.querySelector(`.${period}-max`).value,
                    min: row.querySelector(`.${period}-min`).value,
                    cur: row.querySelector(`.${period}-cur`).value
                });
            }
            return { layers };
        }

        function getSummaryData(period) {
            const maxEl = document.getElementById(`${period}-final-max`).textContent;
            const minEl = document.getElementById(`${period}-final-min`).textContent;
            const avgEl = document.getElementById(`${period}-final-avg`).textContent;
            return {
                max: maxEl !== '-' ? parseFloat(maxEl) : null,
                min: minEl !== '-' ? parseFloat(minEl) : null,
                cur: avgEl !== '-' ? parseFloat(avgEl) : null
            };
        }

        function exportData() {
            const data = localStorage.getItem(storageKey);
            if (!data) { alert("ç„¡è³‡æ–™å¯åŒ¯å‡ºï¼"); return; }
            const blob = new Blob([data], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `ç–«è‹—æº«åº¦å‚™ä»½_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (typeof json === 'object') {
                        if(confirm('è­¦å‘Šï¼šåŒ¯å…¥å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼ç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ')) {
                            localStorage.setItem(storageKey, JSON.stringify(json));
                            alert("åŒ¯å…¥æˆåŠŸï¼");
                            location.reload();
                        }
                    } else alert("æ ¼å¼éŒ¯èª¤");
                } catch (err) { alert("è§£æå¤±æ•—"); }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        function clearData() {
            if(confirm('ç¢ºå®šæ¸…é™¤æœ¬æœˆè³‡æ–™ï¼Ÿ')) {
                const monthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
                const fullData = JSON.parse(localStorage.getItem(storageKey)) || {};
                if (fullData[monthKey]) {
                    delete fullData[monthKey];
                    localStorage.setItem(storageKey, JSON.stringify(fullData));
                    loadDayData();
                    updateMonthlyReport();
                    updateChart();
                    alert('å·²æ¸…é™¤ã€‚');
                }
            }
        }

        function updateMonthlyReport() {
            const monthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            const fullData = JSON.parse(localStorage.getItem(storageKey)) || {};
            const monthData = fullData[monthKey] || {};
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const tbody = document.getElementById('monthlySummaryBody');
            tbody.innerHTML = '';

            for (let i = 1; i <= daysInMonth; i++) {
                const dayData = monthData[i] || { summary: { am: {}, pm: {} }, am: {}, pm: {} };
                const am = dayData.summary?.am || {};
                const pm = dayData.summary?.pm || {};
                
                const amSigHtml = dayData.am?.sigImage 
                    ? `<img src="${dayData.am.sigImage}" class="sig-preview sig-img-print mx-auto">` 
                    : '<span class="text-gray-300">-</span>';
                const pmSigHtml = dayData.pm?.sigImage 
                    ? `<img src="${dayData.pm.sigImage}" class="sig-preview sig-img-print mx-auto">` 
                    : '<span class="text-gray-300">-</span>';

                const dateObj = new Date(currentYear, currentMonth - 1, i);
                const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);

                const row = `
                    <tr class="${isWeekend ? 'bg-gray-100' : 'bg-white'} border-b border-gray-300">
                        <td class="border-r border-gray-300 p-1 font-bold align-middle">${i}</td>
                        <td class="border-r border-gray-300 p-1 align-middle ${getColor(am.max)}">${formatVal(am.max)}</td>
                        <td class="border-r border-gray-300 p-1 align-middle ${getColor(am.min)}">${formatVal(am.min)}</td>
                        <td class="border-r border-gray-300 p-1 align-middle">${formatVal(am.cur)}</td>
                        <td class="border-r border-gray-300 p-1 align-middle ${getColor(pm.max)}">${formatVal(pm.max)}</td>
                        <td class="border-r border-gray-300 p-1 align-middle ${getColor(pm.min)}">${formatVal(pm.min)}</td>
                        <td class="border-r border-gray-300 p-1 align-middle">${formatVal(pm.cur)}</td>
                        <td class="border-r border-gray-300 p-1 align-middle h-10 w-16">${amSigHtml}</td>
                        <td class="border-r border-gray-300 p-1 align-middle h-10 w-16">${pmSigHtml}</td>
                        <td class="border-r border-gray-300 p-1 align-middle"></td>
                    </tr>`;
                tbody.innerHTML += row;
            }
        }

        function formatVal(val) { return (val === null || val === undefined) ? '' : val; }
        function getColor(val) {
            if (val === null || val === undefined) return '';
            if (val > 8) return 'text-red-600 font-bold';
            if (val < 2) return 'text-blue-600 font-bold';
            return '';
        }

        // --- Chart Transformation Logic ---
        // è¦–è¦ºå°æ˜  (0~100):
        // 12åº¦  -> 100
        // 8åº¦   -> 90  (å€é–“ 8~12 ä½” 10%)
        // 2åº¦   -> 40  (å€é–“ 2~8 ä½” 50%)
        // -10åº¦ -> 20  (å€é–“ -10~2 ä½” 20%)
        // -25åº¦ -> 0   (å€é–“ -25~-10 ä½” 20%)
        const transformTemp = (t) => {
            if (t === null || t === undefined) return null;
            if (t > 8) return 90 + (t - 8) * (10 / 4);   // 8~12åº¦ æ˜ å°„åˆ° 90~100
            if (t >= 2) return 40 + (t - 2) * (50 / 6);  // 2~8åº¦ æ˜ å°„åˆ° 40~90 (æ ¸å¿ƒå€æ”¾å¤§)
            if (t >= -10) return 20 + (t - (-10)) * (20 / 12); // -10~2åº¦ æ˜ å°„åˆ° 20~40
            return (t - (-25)) * (20 / 15);              // -25~-10åº¦ æ˜ å°„åˆ° 0~20
        };

        function updateChart() {
            const ctx = document.getElementById('tempChart');
            if(!ctx || typeof Chart === 'undefined') return;

            const monthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            const fullData = JSON.parse(localStorage.getItem(storageKey)) || {};
            const monthData = fullData[monthKey] || {};
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

            const labels = [];
            const rawDataMax = [], rawDataMin = [], rawDataCur = [];

            for (let i = 1; i <= daysInMonth; i++) {
                labels.push(`${i}æ—¥ AM`, `${i}æ—¥ PM`);
                const d = monthData[i] || { summary: { am: {}, pm: {} } };
                const am = d.summary?.am || {};
                const pm = d.summary?.pm || {};
                rawDataMax.push(am.max ?? null, pm.max ?? null);
                rawDataMin.push(am.min ?? null, pm.min ?? null);
                rawDataCur.push(am.cur ?? null, pm.cur ?? null);
            }

            if (chartInstance) chartInstance.destroy();

            // æº–å‚™è½‰æ›å¾Œçš„æ•¸æ“šçµ¦ Chart.js ç¹ªåœ–
            const dataMaxTransformed = rawDataMax.map(transformTemp);
            const dataMinTransformed = rawDataMin.map(transformTemp);
            const dataCurTransformed = rawDataCur.map(transformTemp);

            // å®šç¾©è¦é¡¯ç¤ºçš„åˆ»åº¦ (å°æ‡‰çœŸå¯¦æº«åº¦)
            // åŒ…å«é‚Šç•Œèˆ‡é‡è¦æ•¸å€¼ï¼š12, 8, 2, -10, -25
            const tickTemps = [12, 10, 8, 7, 6, 5, 4, 3, 2, 0, -10, -20, -25];

            chartInstance = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'æœ€é«˜æº«', data: dataMaxTransformed, borderColor: '#ef4444', backgroundColor: '#ef444410', borderWidth: 1.5, tension: 0.1, pointRadius: 2, spanGaps: true },
                        { label: 'æœ€ä½æº«', data: dataMinTransformed, borderColor: '#3b82f6', backgroundColor: '#3b82f610', borderWidth: 1.5, tension: 0.1, pointRadius: 2, spanGaps: true },
                        { label: 'ç•¶ä¸‹æº«', data: dataCurTransformed, borderColor: '#10b981', backgroundColor: '#10b98110', borderWidth: 1.5, tension: 0.1, pointRadius: 2, spanGaps: true }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            min: 0, 
                            max: 100,
                            title: { display: true, text: 'æº«åº¦ (Â°C)' },
                            afterBuildTicks: function(axis) {
                                // å¼·åˆ¶è¨­å®šåˆ»åº¦ä½ç½®ç‚ºæˆ‘å€‘æŒ‡å®šçš„æº«åº¦é»
                                axis.ticks = tickTemps.map(t => ({ value: transformTemp(t) }));
                            },
                            ticks: {
                                callback: function(value, index, ticks) {
                                    // ä½¿ç”¨åç®—æˆ–æ˜¯æ¯”å°
                                    const match = tickTemps.find(t => Math.abs(transformTemp(t) - value) < 0.01);
                                    return match !== undefined ? match + 'Â°C' : '';
                                }
                            }
                        },
                        x: { ticks: { autoSkip: false, maxRotation: 90, minRotation: 90, font: { size: 10 } } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    // Tooltip é¡¯ç¤ºåŸå§‹æº«åº¦ï¼Œè€Œéè½‰æ›å¾Œçš„åº§æ¨™
                                    let rawVal;
                                    const dataIndex = context.dataIndex;
                                    if (context.dataset.label === 'æœ€é«˜æº«') rawVal = rawDataMax[dataIndex];
                                    if (context.dataset.label === 'æœ€ä½æº«') rawVal = rawDataMin[dataIndex];
                                    if (context.dataset.label === 'ç•¶ä¸‹æº«') rawVal = rawDataCur[dataIndex];
                                    return context.dataset.label + ': ' + (rawVal !== null ? rawVal + 'Â°C' : '-');
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                line1: { 
                                    type: 'line', 
                                    yMin: transformTemp(2), yMax: transformTemp(2), 
                                    borderColor: 'blue', borderWidth: 2, borderDash: [6, 6], 
                                    label: { content: '2Â°C', display: true, backgroundColor: 'blue', color: 'white', font: {size: 10} } 
                                },
                                line2: { 
                                    type: 'line', 
                                    yMin: transformTemp(8), yMax: transformTemp(8), 
                                    borderColor: 'red', borderWidth: 2, borderDash: [6, 6], 
                                    label: { content: '8Â°C', display: true, backgroundColor: 'red', color: 'white', font: {size: 10} } 
                                },
                                line3: { 
                                    type: 'line', 
                                    yMin: transformTemp(-10), yMax: transformTemp(-10), 
                                    borderColor: 'orange', borderWidth: 2, borderDash: [6, 6], 
                                    label: { content: '-10Â°C', display: true, backgroundColor: 'orange', color: 'white', font: {size: 10} } 
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>